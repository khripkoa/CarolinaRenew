---
import LayoutService from "../layouts/LayoutService.astro";
import locations from "../data/locations.json";

const title = "Service Areas | Carolina Renew";
const description =
    "Check if Carolina Renew serves your neighborhood. We provide cabinet refinishing and painting services across Charlotte, NC and surrounding areas.";

// Helper to format URL friendly strings
const toSlug = (str: string) => str.toLowerCase().replace(/\s+/g, "-");

// 1. Get all unique Cities/Towns/Suburbs that act as roots
// We need to look at how [...slug].astro determines roots.
// It seems it takes `city` as primary, then `towns`, then `suburbs`.
// But for this list, we want to show ALL distinct "Cities" that people might recognize.
// Let's extract unique values from `city`, `towns`, and `suburbs` fields.

const uniqueCities = new Set<string>();
const uniqueCounties = new Set<string>();
const uniqueStates = new Set<string>();
const uniqueZips = new Set<string>();

locations.forEach((loc) => {
    if (loc.city) uniqueCities.add(loc.city);
    if (loc.towns)
        loc.towns.split(",").forEach((t) => uniqueCities.add(t.trim()));
    // Suburbs are often smaller, but let's include them if they are distinct enough?
    // Actually user asked for "all cities", maybe just City and Towns is enough for "Cities" section?
    // Let's include suburbs too if they are significant, but maybe separate them?
    // For simplicity and "All Cities", let's put them in one list or separate if we want to be precise.
    // Let's stick to City + Towns for the main "Cities" list to avoid cluttering with tiny neighborhoods.

    if (loc.county) {
        // Handle "Cabarrus / Rowan" case
        loc.county.split("/").forEach((c) => uniqueCounties.add(c.trim()));
    }
    if (loc.state) uniqueStates.add(loc.state);
    if (loc.zip_code) uniqueZips.add(loc.zip_code);
});

const sortedCities = Array.from(uniqueCities).sort();
const sortedCounties = Array.from(uniqueCounties).sort();
const sortedStates = Array.from(uniqueStates).sort();
const sortedZips = Array.from(uniqueZips).sort();

// We need to know which "City" each item belongs to for the link.
// This is tricky because a Town might be its own root OR under a City.
// In [...slug].astro:
// If loc.city exists, that is the root. Towns/Suburbs are added to it.
// If loc.city is null, but loc.towns exists, that Town is a root.
// So for linking:
// - If it's a main City (like Charlotte), link is /Charlotte/
// - If it's a Town (like Mint Hill) which is under Charlotte, link is /Charlotte/Mint-Hill/
// - If it's a Town (like Concord) which has NO city in its record, it is a root: /Concord/

// Let's build a map of Item -> Link
const locationLinks = new Map<string, string>();

locations.forEach((loc) => {
    const root = loc.city
        ? loc.city
        : loc.towns
          ? loc.towns.split(",")[0].trim()
          : null;
    if (!root) return;

    // Root link
    locationLinks.set(root, `/${toSlug(root)}/`);

    // Sub-items links
    if (loc.city) {
        if (loc.towns) {
            loc.towns.split(",").forEach((t) => {
                locationLinks.set(
                    t.trim(),
                    `/${toSlug(loc.city)}/${toSlug(t.trim())}/`,
                );
            });
        }
        if (loc.suburbs) {
            loc.suburbs.split(",").forEach((s) => {
                locationLinks.set(
                    s.trim(),
                    `/${toSlug(loc.city)}/${toSlug(s.trim())}/`,
                );
            });
        }
    }
});
---

<LayoutService title={title} description={description}>
    <div class="bg-blue-900 text-white py-20">
        <div class="w-full px-4 sm:px-8 lg:px-12 xl:px-16 text-center">
            <h1 class="page-title">Service Areas</h1>
            <p class="text-xl text-blue-100 max-w-3xl mx-auto">
                Proudly serving homeowners across the greater Charlotte
                metropolitan area and beyond.
            </p>
        </div>
    </div>

    <section class="py-16 bg-white">
        <div class="w-full px-4 sm:px-8 lg:px-12 xl:px-16">
            <div class="text-center mb-12">
                <h2 class="section-title-sm">Where We Work</h2>
                <p class="text-gray-600 max-w-2xl mx-auto">
                    We are based in Charlotte, NC, but our team travels
                    throughout the region. Below is a complete list of the areas
                    we serve.
                </p>
            </div>

            <div class="space-y-8">
                <!-- States -->
                <div
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                >
                    <h3
                        class="font-bold text-xl text-gray-900 mb-6 pb-3 border-b border-gray-100 flex items-center"
                    >
                        <svg
                            class="w-6 h-6 text-purple-600 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                            ></path></svg
                        >
                        States
                    </h3>
                    <div class="flex gap-4">
                        {
                            sortedStates.map((state) => (
                                <a
                                    href={`/${state}/`}
                                    class="inline-flex items-center px-4 py-2 rounded-lg bg-purple-50 text-purple-700 font-bold border border-purple-100 hover:bg-purple-100 hover:border-purple-200 transition-colors"
                                >
                                    {state === "NC"
                                        ? "North Carolina"
                                        : state === "SC"
                                          ? "South Carolina"
                                          : state}
                                </a>
                            ))
                        }
                    </div>
                </div>

                <!-- Counties -->
                <div
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                >
                    <h3
                        class="font-bold text-xl text-gray-900 mb-6 pb-3 border-b border-gray-100 flex items-center"
                    >
                        <svg
                            class="w-6 h-6 text-green-600 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
                            ></path></svg
                        >
                        Counties
                    </h3>
                    <ul class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        {
                            sortedCounties.map((county) => (
                                <li>
                                    <a
                                        href={`/${toSlug(county)}-County/`}
                                        class="flex items-center text-gray-700 hover:text-green-600 group transition-colors"
                                    >
                                        <svg
                                            class="w-4 h-4 text-green-400 mr-2 group-hover:text-green-600 transition-colors"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M5 13l4 4L19 7"
                                            />
                                        </svg>
                                        {county} County
                                    </a>
                                </li>
                            ))
                        }
                    </ul>
                </div>

                <!-- Cities & Towns -->
                <div
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                >
                    <h3
                        class="font-bold text-xl text-gray-900 mb-6 pb-3 border-b border-gray-100 flex items-center"
                    >
                        <svg
                            class="w-6 h-6 text-blue-600 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                            ></path></svg
                        >
                        Cities & Towns
                    </h3>
                    <ul
                        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
                    >
                        {
                            sortedCities.map((city) => {
                                const link = locationLinks.get(city) || "#";
                                return (
                                    <li>
                                        <a
                                            href={link}
                                            class="flex items-center text-gray-700 hover:text-blue-600 group transition-colors"
                                        >
                                            <span class="w-2 h-2 bg-blue-400 rounded-full mr-2 opacity-0 group-hover:opacity-100 transition-opacity" />
                                            {city}
                                        </a>
                                    </li>
                                );
                            })
                        }
                    </ul>
                </div>

                <!-- Zip Codes -->
                <div
                    class="bg-white p-6 rounded-xl shadow-sm border border-gray-200"
                >
                    <h3
                        class="font-bold text-xl text-gray-900 mb-6 pb-3 border-b border-gray-100 flex items-center"
                    >
                        <svg
                            class="w-6 h-6 text-orange-600 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                            ><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                            ></path><path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                            ></path></svg
                        >
                        Zip Codes
                    </h3>
                    <div class="columns-3 md:columns-5 lg:columns-6 gap-4">
                        {
                            sortedZips.map((zip) => {
                                // Find a city for this zip to build the link
                                // We can just grab the first location that has this zip
                                const loc = locations.find(
                                    (l) => l.zip_code === zip,
                                );
                                const root =
                                    loc?.city ||
                                    (loc?.towns
                                        ? loc.towns.split(",")[0].trim()
                                        : loc?.suburbs
                                          ? loc.suburbs.split(",")[0].trim()
                                          : "Charlotte");
                                const link = `/${toSlug(root)}/${zip}/`;

                                return (
                                    <div class="break-inside-avoid mb-2">
                                        <a
                                            href={link}
                                            class="text-gray-600 hover:text-orange-600 hover:underline transition-colors text-sm"
                                        >
                                            {zip}
                                        </a>
                                    </div>
                                );
                            })
                        }
                    </div>
                </div>
            </div>

            <div class="mt-16 bg-gray-50 p-8 rounded-2xl text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-4">
                    Don't see your area?
                </h3>
                <p class="text-gray-600 mb-6">
                    We are constantly expanding our service range. Give us a
                    call to check if we can come to you.
                </p>
                <a
                    href="tel:+19804088122"
                    class="inline-flex items-center text-orange-600 font-bold hover:text-orange-700 text-lg"
                >
                    <svg
                        class="w-5 h-5 mr-2"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                        ></path></svg
                    >
                    (980) 408-8122
                </a>
            </div>
        </div>
    </section>
</LayoutService>
