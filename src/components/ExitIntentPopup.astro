---
// ExitIntentPopup - Captures users before they leave
---

<div
    x-data="{
    show: false,
    hasShown: false,
    init() {
      // Check if already shown in this session
      if (sessionStorage.getItem('exitPopupShown')) {
        this.hasShown = true;
        return;
      }
      
      // Desktop: Mouse leave detection
      document.addEventListener('mouseout', (e) => {
        if (!this.hasShown && e.clientY < 10 && e.relatedTarget === null) {
          this.show = true;
          this.hasShown = true;
          sessionStorage.setItem('exitPopupShown', 'true');
        }
      });
      
      // Mobile: Back button / scroll up detection
      let lastScrollY = window.scrollY;
      window.addEventListener('scroll', () => {
        if (!this.hasShown && window.scrollY < lastScrollY - 100 && window.scrollY < 100) {
          this.show = true;
          this.hasShown = true;
          sessionStorage.setItem('exitPopupShown', 'true');
        }
        lastScrollY = window.scrollY;
      });
    },
    close() {
      this.show = false;
    }
  }"
    x-show="show"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-[60] flex items-center justify-center p-4"
    style="display: none;"
    @keydown.escape.window="close()"
>
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" @click="close()">
    </div>

    <!-- Modal -->
    <div
        x-show="show"
        x-transition:enter="transition ease-out duration-300 delay-100"
        x-transition:enter-start="opacity-0 scale-90"
        x-transition:enter-end="opacity-100 scale-100"
        class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden"
    >
        <!-- Close Button -->
        <button
            @click="close()"
            class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100 hover:bg-gray-200 transition z-10"
        >
            <svg
                class="w-4 h-4 text-gray-500"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Header -->
        <div
            class="bg-gradient-to-r from-orange-600 to-orange-500 p-6 text-center"
        >
            <div class="text-4xl mb-2">üéÅ</div>
            <h3 class="text-2xl font-bold text-white">Wait! Don't Miss Out</h3>
            <p class="text-orange-100 text-sm mt-1">
                Get 10% OFF your first project
            </p>
        </div>

        <!-- Content -->
        <div class="p-6">
            <p class="text-gray-600 text-center mb-6">
                Leave your email and we'll send you an exclusive discount code
                for your home improvement project.
            </p>

            <form
                class="space-y-4"
                x-data="{ email: '', submitted: false }"
                @submit.prevent="
          if (email && email.includes('@')) {
            // Store email for follow-up
            fetch('/api/telegram-webhook', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                type: 'exit_intent',
                email: email,
                page: window.location.pathname
              })
            });
            submitted = true;
          }
        "
            >
                <div x-show="!submitted">
                    <input
                        type="email"
                        x-model="email"
                        placeholder="Enter your email"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none transition"
                        required
                    />
                    <button
                        type="submit"
                        class="w-full mt-3 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform hover:scale-105"
                    >
                        Get My 10% Discount
                    </button>
                </div>

                <div x-show="submitted" class="text-center py-4">
                    <div class="text-4xl mb-2">‚úÖ</div>
                    <p class="text-green-600 font-semibold">
                        Check your email for the discount code!
                    </p>
                </div>
            </form>

            <p class="text-xs text-gray-400 text-center mt-4">
                No spam, unsubscribe anytime. By submitting, you agree to our
                <a href="/privacy/" class="underline">Privacy Policy</a>.
            </p>
        </div>

        <!-- Trust Elements -->
        <div
            class="bg-gray-50 px-6 py-4 flex items-center justify-center gap-6 text-xs text-gray-500"
        >
            <div class="flex items-center gap-1">
                <svg
                    class="w-4 h-4 text-yellow-500"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                >
                    <path
                        d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
                    ></path>
                </svg>
                5.0 Rating
            </div>
            <div>500+ Projects</div>
            <div>Since 2021</div>
        </div>
    </div>
</div>
